name: Setup PostgreSQL on Server

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-postgresql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.IP }} >> ~/.ssh/known_hosts

      - name: Check if PostgreSQL is already running
        id: check_postgres
        run: |
          CHECK_RESULT=$(ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} 'if command -v docker >/dev/null 2>&1; then if docker ps --filter "name=postgresql" --filter "status=running" --format "{{.Names}}" 2>/dev/null | grep -q "^postgresql$"; then echo "RUNNING"; else echo "NOT_RUNNING"; fi; else echo "DOCKER_NOT_INSTALLED"; fi' 2>/dev/null)

          CHECK_RESULT=$(echo "$CHECK_RESULT" | xargs)
          echo "Check result: '$CHECK_RESULT'"

          if [ "$CHECK_RESULT" = "RUNNING" ]; then
            echo "postgres_running=true" >> $GITHUB_OUTPUT
            echo "✅ PostgreSQL container is already running"
          else
            echo "postgres_running=false" >> $GITHUB_OUTPUT
            if [ "$CHECK_RESULT" = "DOCKER_NOT_INSTALLED" ]; then
              echo "⚠️  Docker is not installed on the server"
            else
              echo "⚠️  PostgreSQL container is not running"
            fi
          fi

      - name: Exit if PostgreSQL is already running
        if: steps.check_postgres.outputs.postgres_running == 'true'
        run: |
          echo "✅ PostgreSQL is already installed and running on the server"
          exit 0

      - name: Install Docker on server
        if: steps.check_postgres.outputs.postgres_running == 'false'
        run: |
          ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} bash -s << EOF
            export PASSWORD='${{ secrets.PASSWORD }}'
            
            # Check if Docker is already installed
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              
              # Update package index
              echo "\$PASSWORD" | sudo -S apt-get update
              
              # Install prerequisites
              echo "\$PASSWORD" | sudo -S apt-get install -y ca-certificates curl
              
              # Add Docker's official GPG key
              echo "\$PASSWORD" | sudo -S install -m 0755 -d /etc/apt/keyrings
              echo "\$PASSWORD" | sudo -S curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
              echo "\$PASSWORD" | sudo -S chmod a+r /etc/apt/keyrings/docker.asc
              
              # Add Docker repository
              echo \
                "deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                \$(. /etc/os-release && echo "\$VERSION_CODENAME") stable" | \
                echo "\$PASSWORD" | sudo -S tee /etc/apt/sources.list.d/docker.list > /dev/null
              
              # Install Docker
              echo "\$PASSWORD" | sudo -S apt-get update
              echo "\$PASSWORD" | sudo -S apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              
              # Add user to docker group
              echo "\$PASSWORD" | sudo -S usermod -aG docker \$USER
              
              echo "Docker installed successfully"
            else
              echo "Docker is already installed"
            fi
          EOF

      - name: Setup PostgreSQL 18 container
        if: steps.check_postgres.outputs.postgres_running == 'false'
        run: |
          ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} bash -s << EOF
            # Create directory for PostgreSQL data
            mkdir -p ~/postgresql/data
            
            # Pull PostgreSQL 18 image
            docker pull postgres:18
            
            # Run PostgreSQL container
            docker run -d \
              --name postgresql \
              --restart unless-stopped \
              -e POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}' \
              -e POSTGRES_USER='${{ secrets.POSTGRES_USER }}' \
              -e POSTGRES_DB='${{ secrets.POSTGRES_DB }}' \
              -p ${{ secrets.POSTGRES_PORT }}:5432 \
              -v ~/postgresql/data:/var/lib/postgresql/data \
              postgres:18
            
            # Wait for PostgreSQL to be ready
            echo "Waiting for PostgreSQL to be ready..."
            sleep 10
            
            # Verify PostgreSQL is running
            docker ps --filter "name=postgresql"
            
            echo "✅ PostgreSQL 18 has been successfully installed and started"
          EOF

      - name: Verify installation
        if: steps.check_postgres.outputs.postgres_running == 'false'
        run: |
          ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} \
            "docker exec postgresql psql -U ${{ secrets.POSTGRES_USER }} -c 'SELECT version();'" 2>/dev/null

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
