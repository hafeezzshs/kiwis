name: Setup PostgreSQL on Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-postgresql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.IP }} >> ~/.ssh/known_hosts

      - name: Check server state (Docker + PostgreSQL container)
        id: check_postgres
        run: |
          set -euo pipefail
          CHECK_RESULT=$(ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} '
            set -euo pipefail
            if command -v docker >/dev/null 2>&1; then
              if docker ps --filter "name=postgresql" --filter "status=running" --format "{{.Names}}" | grep -q "^postgresql$"; then
                echo RUNNING
              else
                # Distinguish between "exists but stopped" and "not present"
                if docker ps -a --format "{{.Names}}" | grep -q "^postgresql$"; then
                  echo EXISTS_NOT_RUNNING
                else
                  echo NOT_RUNNING
                fi
              fi
            else
              echo DOCKER_NOT_INSTALLED
            fi
          ' | tr -d '\r' | xargs || true)

          if [ -z "${CHECK_RESULT:-}" ]; then
            echo "‚ùå SSH command returned no result ‚Äî aborting"
            exit 1
          fi

          echo "Check result: '${CHECK_RESULT}'"
          case "$CHECK_RESULT" in
            RUNNING)
              echo "postgres_running=true" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "postgres_running=false" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Exit early if PostgreSQL already running
        if: steps.check_postgres.outputs.postgres_running == 'true'
        run: |
          echo "‚úÖ PostgreSQL is already installed and running on the server"
          exit 0

      - name: Ensure Docker is installed (with passworded sudo)
        run: |
          set -euo pipefail
          ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} "export PASSWORD='${{ secrets.PASSWORD }}'; bash -s" << 'EOF'
          set -euo pipefail

          run_sudo() { echo "$PASSWORD" | sudo -S "$@"; }

          # Validate sudo password early (fails fast if wrong)
          if ! echo "$PASSWORD" | sudo -S -v >/dev/null 2>&1; then
            echo "‚ùå Incorrect sudo password provided"
            exit 1
          fi

          if ! command -v docker >/dev/null 2>&1; then
            echo "üîß Installing Docker..."
            run_sudo apt-get update
            run_sudo apt-get install -y ca-certificates curl

            run_sudo install -m 0755 -d /etc/apt/keyrings
            run_sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            run_sudo chmod a+r /etc/apt/keyrings/docker.asc

            # Correct repository line (single tee; no nested echo)
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
              | run_sudo tee /etc/apt/sources.list.d/docker.list >/dev/null

            run_sudo apt-get update
            run_sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

            # Ensure docker group exists, then add current user
            run_sudo groupadd -f docker
            run_sudo usermod -aG docker "$USER"

            echo "‚úÖ Docker installed successfully"
          else
            echo "‚úÖ Docker already present"
          fi
          EOF

      - name: Provision/Start PostgreSQL 18 container
        run: |
          set -euo pipefail
          ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} "export PASSWORD='${{ secrets.PASSWORD }}'; bash -s" << 'EOF'
          set -euo pipefail
          run_sudo() { echo "$PASSWORD" | sudo -S "$@"; }

          # Create data directory (under the user's HOME)
          mkdir -p "$HOME/postgresql/data"

          # If a container named 'postgresql' exists but isn't running, remove it cleanly
          if run_sudo docker ps -a --format '{{.Names}}' | grep -q '^postgresql$'; then
            if ! run_sudo docker ps --format '{{.Names}}' | grep -q '^postgresql$'; then
              echo "‚ôªÔ∏è  Removing existing stopped container 'postgresql'..."
              run_sudo docker rm -f postgresql
            fi
          fi

          # Start (or re-create) the container
          if ! run_sudo docker ps --format '{{.Names}}' | grep -q '^postgresql$'; then
            echo "üöÄ Starting PostgreSQL 18 container..."
            run_sudo docker run --pull always -d \
              --name postgresql \
              --restart unless-stopped \
              -e POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}' \
              -e POSTGRES_USER='${{ secrets.POSTGRES_USER }}' \
              -e POSTGRES_DB='${{ secrets.POSTGRES_DB }}' \
              -p ${{ secrets.POSTGRES_PORT }}:5432 \
              -v "$HOME/postgresql/data":/var/lib/postgresql/data \
              postgres:18
          else
            echo "‚ñ∂Ô∏è  Container already running: postgresql"
          fi

          # Wait for readiness with pg_isready
          echo "‚è≥ Waiting for PostgreSQL readiness..."
          for i in {1..30}; do
            if run_sudo docker exec postgresql pg_isready -U '${{ secrets.POSTGRES_USER }}' >/dev/null 2>&1; then
              echo "‚úÖ PostgreSQL is ready"
              exit 0
            fi
            sleep 2
          done

          echo "‚ùå PostgreSQL did not become ready in time"
          exit 1
          EOF

      - name: Verify PostgreSQL (version)
        run: |
          set -euo pipefail
          ssh -tt -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.USER }}@${{ secrets.IP }} "export PASSWORD='${{ secrets.PASSWORD }}'; bash -s" << 'EOF'
          set -euo pipefail
          run_sudo() { echo "$PASSWORD" | sudo -S "$@"; }

          if run_sudo docker ps --format '{{.Names}}' | grep -q '^postgresql$'; then
            echo "üîé Checking server version..."
            run_sudo docker exec postgresql psql -U '${{ secrets.POSTGRES_USER }}' -c 'SELECT version();'
            echo "‚úÖ PostgreSQL container verified"
          else
            echo "‚ùå PostgreSQL container is not running"
            exit 1
          fi
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key